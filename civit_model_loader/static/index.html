<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civitai Model Loader</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- DOMPurify for secure HTML sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.7/dist/purify.min.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>ðŸ¤– Civitai Model Loader</h1>
            <p>Discover and download AI models from Civitai</p>
        </header>

        <div class="main-content">
            <!-- Configuration Section -->
            <section class="config-section">
                <h2>Configuration</h2>
                <div class="config-controls">
                    <button id="exportConfig">Export Config</button>
                    <input type="file" id="importConfig" accept=".json" style="display: none;">
                    <button id="importConfigBtn">Import Config</button>
                </div>
            </section>
            <!-- API Token Section -->
            <section class="token-section">
                <h2>API Configuration</h2>

                <!-- Token loaded state (hidden by default) -->
                <div id="tokenLoadedState" class="token-loaded-group" style="display: none;">
                    <div class="token-status">
                        <span class="checkmark">âœ“</span>
                        <span class="token-status-text">Token loaded successfully</span>
                    </div>
                    <div class="token-actions">
                        <button id="changeToken" class="secondary-btn">Change Token</button>
                        <button id="testTokenLoaded">Test Token</button>
                    </div>
                </div>

                <!-- Token input state (visible by default) -->
                <div id="tokenInputState" class="token-input-group">
                    <form onsubmit="return false;">
                        <input type="password" id="apiToken" placeholder="Enter your Civitai API token">
                        <button type="button" id="saveToken">Save Token</button>
                        <button type="button" id="testToken">Test Token</button>
                    </form>
                </div>

                <p class="token-help">
                    Get your API token from <a href="https://civitai.com/user/account" target="_blank">Civitai Account
                        Settings</a>
                </p>
            </section>

            <!-- Unified Search Section -->
            <section class="search-section">
                <h2>Search Models</h2>
                <div class="search-form">
                    <!-- Search Mode Toggle -->
                    <div class="search-mode-row">
                        <div class="search-mode-toggle">
                            <label>
                                <input type="radio" name="searchMode" value="query" id="searchModeQuery" checked>
                                Search by Name/Keywords
                            </label>
                            <label>
                                <input type="radio" name="searchMode" value="id" id="searchModeId">
                                Search by Model ID
                            </label>
                        </div>
                    </div>

                    <!-- Search Input Row -->
                    <div class="search-row">
                        <input type="text" id="searchQuery" placeholder="Search for models..." style="display: block;">
                        <input type="number" id="modelIdInput" placeholder="Enter model ID (e.g., 12345)" min="1"
                            style="display: none;">
                        <button id="searchBtn">Search</button>
                    </div>

                    <!-- Filter Row (only for query search) -->
                    <div class="filter-row" id="filterRow">
                        <select id="modelType">
                            <option value="">All Types</option>
                            <option value="Checkpoint">Checkpoint</option>
                            <option value="LORA">LORA</option>
                            <option value="LyCORIS">LyCORIS</option>
                            <option value="TextualInversion">Textual Inversion</option>
                            <option value="Controlnet">ControlNet</option>
                            <option value="VAE">VAE</option>
                            <option value="Upscaler">Upscaler</option>
                        </select>
                        <select id="sortBy">
                            <option value="Most Downloaded">Most Downloaded</option>
                            <option value="Most Liked">Most Liked</option>
                            <option value="Newest">Newest</option>
                            <option value="Most Commented">Most Commented</option>
                        </select>
                        <label>
                            <input type="checkbox" id="nsfwFilter">
                            Include NSFW
                        </label>
                    </div>
                </div>

                <div id="searchResults" class="search-results">
                    <!-- Search results will be populated here -->
                </div>

                <div id="pagination" class="pagination">
                    <!-- Pagination controls will be added here -->
                </div>
            </section>

            <!-- Download Queue Section -->
            <section class="queue-section">
                <h2>Download Queue</h2>
                <div id="downloadQueue" class="download-queue">
                    <!-- Download items will be populated here -->
                </div>
            </section>

            <!-- Downloaded Models Section -->
            <section class="downloaded-section">
                <h2>Downloaded Models</h2>
                <div class="downloaded-controls">
                    <button id="refreshDownloaded">Refresh</button>
                </div>
                <div id="downloadedModels" class="downloaded-models">
                    <!-- Downloaded models will be populated here -->
                </div>
            </section>

            <!-- Image Conversion Section -->
            <section class="conversion-section">
                <h2>Output Images</h2>
                <p class="conversion-help">
                    Convert InvokeAI generated images to Automatic1111 format and download as ZIP
                </p>
                <div class="conversion-form">
                    <div class="conversion-row">
                        <input type="text" id="imageDirectory" placeholder="Directory path..."
                            value="/workspace/output/images">
                        <button id="downloadImagesBtn">Download Converted Images</button>
                        <button id="refreshGalleryBtn">Refresh Gallery</button>
                    </div>
                    <div class="conversion-row">
                        <label>
                            <input type="checkbox" id="autoSortCheckbox" checked>
                            Auto-sort images by prompt keywords before zipping
                        </label>
                    </div>
                </div>
                <div id="conversionStatus" class="conversion-status">
                    <!-- Conversion status will be shown here -->
                </div>

                <!-- Thumbnail Gallery -->
                <div class="gallery-section">
                    <h3>Image Gallery</h3>
                    <div id="thumbnailGallery" class="thumbnail-gallery">
                        <!-- Thumbnails will be populated here -->
                    </div>
                    <div id="galleryStatus" class="gallery-status">
                        <!-- Gallery status will be shown here -->
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal for model details -->
    <div id="modelModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modelDetails">
                <!-- Model details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="lightboxModal" class="lightbox-modal">
        <div class="lightbox-content">
            <span class="lightbox-close">&times;</span>
            <img id="lightboxImage" src="" alt="">
            <div class="lightbox-info">
                <h4 id="lightboxFilename"></h4>
                <p id="lightboxPath"></p>
            </div>
            <div class="lightbox-nav">
                <button id="lightboxPrev" class="lightbox-nav-btn">&larr; Previous</button>
                <button id="lightboxNext" class="lightbox-nav-btn">Next &rarr;</button>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast" class="toast"></div>

    <script type="module" src="/static/app.js"></script>
</body>

</html>